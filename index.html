<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JSONL Viewer</title>
  <style>
    /* ─────────────────────────────────────────────
       CSS VARIABLES – Light & Dark themes
    ───────────────────────────────────────────── */
    :root {
      --bg-primary:       #f7f6f3;
      --bg-secondary:     #ffffff;
      --bg-panel:         #ffffff;
      --bg-textarea:      #fafaf8;
      --bg-line:          #ffffff;
      --bg-line-hover:    #f7f6f3;
      --bg-line-error:    #fff5f5;
      --bg-btn:           #1a1a1a;
      --bg-btn-hover:     #333333;
      --bg-badge:         #f0ede8;
      --bg-copy-btn:      #f0ede8;
      --bg-copy-hover:    #e4e0d8;

      --border:           #e4e0d8;
      --border-focus:     #1a1a1a;
      --border-error:     #e05252;

      --text-primary:     #1a1a1a;
      --text-secondary:   #6b6860;
      --text-muted:       #9e9b94;
      --text-btn:         #ffffff;
      --text-error:       #c0392b;

      --accent:           #d4a849;
      --accent-subtle:    #fdf6e3;

      /* JSON Syntax Colors */
      --json-key:         #8b5cf6;
      --json-string:      #059669;
      --json-number:      #d97706;
      --json-boolean:     #dc2626;
      --json-null:        #6b7280;
      --json-bracket:     #374151;

      --shadow-sm:        0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md:        0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
      --shadow-panel:     0 0 0 1px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);

      --radius-sm:        6px;
      --radius-md:        10px;
      --radius-lg:        14px;

      --font-mono:        'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', monospace;
      --font-ui:          'DM Sans', 'Outfit', system-ui, sans-serif;

      --transition:       0.18s ease;
    }

    [data-theme="dark"] {
      --bg-primary:       #0f0f0f;
      --bg-secondary:     #161616;
      --bg-panel:         #161616;
      --bg-textarea:      #1a1a1a;
      --bg-line:          #1c1c1c;
      --bg-line-hover:    #222222;
      --bg-line-error:    #1f1212;
      --bg-btn:           #ffffff;
      --bg-btn-hover:     #e8e8e8;
      --bg-badge:         #2a2a2a;
      --bg-copy-btn:      #2a2a2a;
      --bg-copy-hover:    #333333;

      --border:           #2a2a2a;
      --border-focus:     #ffffff;
      --border-error:     #e05252;

      --text-primary:     #f0f0f0;
      --text-secondary:   #888888;
      --text-muted:       #555555;
      --text-btn:         #0f0f0f;
      --text-error:       #f08080;

      --accent:           #d4a849;
      --accent-subtle:    #1e1a10;

      --json-key:         #c084fc;
      --json-string:      #34d399;
      --json-number:      #fbbf24;
      --json-boolean:     #f87171;
      --json-null:        #9ca3af;
      --json-bracket:     #d1d5db;

      --shadow-sm:        0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
      --shadow-md:        0 4px 12px rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.2);
      --shadow-panel:     0 0 0 1px rgba(255,255,255,0.06), 0 4px 16px rgba(0,0,0,0.3);
    }

    /* ─────────────────────────────────────────────
       RESET & BASE
    ───────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { height: 100%; font-size: 14px; }

    body {
      font-family: var(--font-ui);
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background var(--transition), color var(--transition);
    }

    /* ─────────────────────────────────────────────
       HEADER
    ───────────────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      z-index: 10;
      flex-shrink: 0;
      transition: background var(--transition), border-color var(--transition);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 28px;
      height: 28px;
      background: var(--text-primary);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .logo svg { width: 16px; height: 16px; }

    h1 {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    h1 span {
      color: var(--accent);
    }

    .header-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      background: var(--bg-badge);
      border-radius: 4px;
      padding: 2px 7px;
      border: 1px solid var(--border);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ─────────────────────────────────────────────
       BUTTONS
    ───────────────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-ui);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      white-space: nowrap;
      user-select: none;
    }

    .btn:hover {
      background: var(--bg-line-hover);
      border-color: var(--text-muted);
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: var(--bg-btn);
      color: var(--text-btn);
      border-color: var(--bg-btn);
    }

    .btn-primary:hover {
      background: var(--bg-btn-hover);
      border-color: var(--bg-btn-hover);
    }

    .btn svg {
      width: 13px;
      height: 13px;
      flex-shrink: 0;
    }

    /* ─────────────────────────────────────────────
       MAIN LAYOUT
    ───────────────────────────────────────────── */
    .app-body {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    .panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-panel);
      transition: background var(--transition);
    }

    .panel-left {
      width: 40%;
      min-width: 280px;
      border-right: 1px solid var(--border);
      transition: border-color var(--transition);
    }

    .panel-right {
      flex: 1;
      min-width: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      height: 41px;          /* fixed height keeps both headers pixel-aligned */
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
      flex-shrink: 0;
      transition: background var(--transition), border-color var(--transition);
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .panel-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-stat {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* ─────────────────────────────────────────────
       TEXTAREA
    ───────────────────────────────────────────── */
    .textarea-wrap {
      flex: 1;
      padding: 12px;
      overflow: hidden;
      display: flex;
    }

    #jsonl-input {
      flex: 1;
      width: 100%;
      resize: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-textarea);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 12.5px;
      line-height: 1.7;
      padding: 14px 16px;
      outline: none;
      transition: border-color var(--transition), background var(--transition);
      box-shadow: var(--shadow-sm);
    }

    #jsonl-input::placeholder {
      color: var(--text-muted);
      font-family: var(--font-ui);
      font-size: 13px;
    }

    #jsonl-input:focus {
      border-color: var(--border-focus);
      box-shadow: var(--shadow-md);
    }

    #jsonl-input::-webkit-scrollbar { width: 8px; }
    #jsonl-input::-webkit-scrollbar-track {
      background: var(--bg-badge);
      border-radius: 4px;
      margin: 4px 0;
    }
    #jsonl-input::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 4px;
    }
    #jsonl-input::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ─────────────────────────────────────────────
       OUTPUT PANEL SCROLL AREA
    ───────────────────────────────────────────── */
    #output {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #output::-webkit-scrollbar { width: 8px; }
    #output::-webkit-scrollbar-track {
      background: var(--bg-badge);
      border-radius: 4px;
      margin: 4px 0;
    }
    #output::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 4px;
    }
    #output::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ─────────────────────────────────────────────
       EMPTY STATE
    ───────────────────────────────────────────── */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px 20px;
    }

    .empty-state-icon {
      width: 44px;
      height: 44px;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 13px;
      line-height: 1.5;
    }

    .empty-state code {
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--bg-badge);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--text-secondary);
    }

    /* ─────────────────────────────────────────────
       JSON LINE CARDS
    ───────────────────────────────────────────── */
    .json-line {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-line);
      overflow: visible;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), border-color var(--transition), box-shadow var(--transition);
    }

    .json-line:hover {
      background: var(--bg-line-hover);
      box-shadow: var(--shadow-md);
    }

    .json-line.error {
      border-color: var(--border-error);
      background: var(--bg-line-error);
    }

    .json-line.error:hover {
      background: var(--bg-line-error);
    }

    .json-line-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      min-height: 40px;
    }

    /* Line number badge */
    .line-num {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-badge);
      border-radius: 4px;
      padding: 2px 6px;
      min-width: 28px;
      text-align: center;
      flex-shrink: 0;
      border: 1px solid var(--border);
    }

    .json-line.error .line-num {
      background: #fee2e2;
      color: var(--text-error);
      border-color: #fca5a5;
    }

    [data-theme="dark"] .json-line.error .line-num {
      background: #3b1414;
      border-color: #7f1d1d;
    }

    /* Toggle button */
    .btn-toggle {
      width: 22px;
      height: 22px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg-copy-btn);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all var(--transition);
      font-family: monospace;
    }

    .btn-toggle:hover {
      background: var(--bg-copy-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .btn-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-toggle:active { transform: scale(0.9); }

    /* JSON inline content (collapsed) */
    .json-inline {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
      min-width: 0;
    }

    /* Error label */
    .error-label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-error);
      flex-shrink: 0;
    }

    .error-label svg {
      width: 12px;
      height: 12px;
    }

    /* Copy button */
    .btn-copy {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-copy-btn);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all var(--transition);
      position: relative;
    }

    .btn-copy:hover {
      background: var(--bg-copy-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .btn-copy:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-copy svg { width: 13px; height: 13px; }

    .btn-copy.copied {
      color: #059669;
      border-color: #059669;
      background: #ecfdf5;
    }

    [data-theme="dark"] .btn-copy.copied {
      background: #052e16;
      border-color: #16a34a;
    }

    /* ─────────────────────────────────────────────
       EXPANDED JSON CONTENT
    ───────────────────────────────────────────── */
    .json-body {
      overflow: hidden;
      height: 0;
      opacity: 0;
      padding: 0 12px;
      border-top: 0px solid var(--border);
      transition: height 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.2s ease,
                  padding 0.2s ease;
    }

    .json-line.expanded .json-body {
      /* height is set dynamically in JS to scrollHeight */
      opacity: 1;
      padding: 10px 12px 12px;
      border-top-width: 1px;
      overflow-x: auto;
    }

    .json-pre {
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.75;
      white-space: pre;          /* no wrapping — let content overflow */
      word-break: normal;
      background: var(--bg-textarea);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      border: 1px solid var(--border);
      overflow-x: auto;
      min-width: 0;
    }

    .json-pre::-webkit-scrollbar { height: 6px; }
    .json-pre::-webkit-scrollbar-track {
      background: var(--bg-badge);
      border-radius: 3px;
    }
    .json-pre::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }
    .json-pre::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Error message block */
    .error-body {
      border-top: 1px solid var(--border-error);
      padding: 10px 12px 12px;
    }

    .error-raw {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-textarea);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      white-space: pre-wrap;
      word-break: break-all;
      border: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .error-msg {
      font-size: 11.5px;
      color: var(--text-error);
      background: transparent;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.5;
    }

    .error-msg svg {
      width: 13px;
      height: 13px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* ─────────────────────────────────────────────
       JSON SYNTAX HIGHLIGHTING
    ───────────────────────────────────────────── */
    .jk  { color: var(--json-key); }       /* key */
    .js  { color: var(--json-string); }    /* string value */
    .jn  { color: var(--json-number); }    /* number */
    .jb  { color: var(--json-boolean); }   /* boolean */
    .jz  { color: var(--json-null); }      /* null */
    .jp  { color: var(--json-bracket); }   /* punctuation */

    /* ─────────────────────────────────────────────
       SCROLLBAR (output)
    ───────────────────────────────────────────── */
    .panel-right #output { scrollbar-gutter: stable; }

    /* ─────────────────────────────────────────────
       RESPONSIVE TWEAKS
    ───────────────────────────────────────────── */
    @media (max-width: 700px) {
      .app-body { flex-direction: column; }
      .panel-left { width: 100%; min-width: unset; border-right: none; border-bottom: 1px solid var(--border); height: 35%; }
      .panel-right { height: 65%; }
      .header-badge { display: none; }
    }

    /* ─────────────────────────────────────────────
       FOCUS RING UTILITY
    ───────────────────────────────────────────── */
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    :focus:not(:focus-visible) { outline: none; }
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════
       HEADER
  ═══════════════════════════════════════ -->
  <header>
    <div class="header-left">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="3" width="14" height="2" rx="1" fill="currentColor" opacity="0.9"/>
          <rect x="1" y="7" width="10" height="2" rx="1" fill="currentColor" opacity="0.7"/>
          <rect x="1" y="11" width="12" height="2" rx="1" fill="currentColor" opacity="0.5"/>
        </svg>
      </div>
      <h1>JSONL <span>Viewer</span></h1>
      <span class="header-badge">Client-side</span>
    </div>
    <div class="header-right">
      <button class="btn" id="btn-expand-all" aria-label="Expand all lines">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 6l4 4 4-4"/>
        </svg>
        Expand all
      </button>
      <button class="btn" id="btn-collapse-all" aria-label="Collapse all lines">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 10l4-4 4 4"/>
        </svg>
        Collapse all
      </button>
      <button class="btn btn-primary" id="btn-theme" aria-label="Toggle theme">
        <svg id="theme-icon-sun" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
          <circle cx="8" cy="8" r="3"/>
          <line x1="8" y1="1" x2="8" y2="2.5"/>
          <line x1="8" y1="13.5" x2="8" y2="15"/>
          <line x1="1" y1="8" x2="2.5" y2="8"/>
          <line x1="13.5" y1="8" x2="15" y2="8"/>
          <line x1="3.05" y1="3.05" x2="4.1" y2="4.1"/>
          <line x1="11.9" y1="11.9" x2="12.95" y2="12.95"/>
          <line x1="12.95" y1="3.05" x2="11.9" y2="4.1"/>
          <line x1="4.1" y1="11.9" x2="3.05" y2="12.95"/>
        </svg>
        <svg id="theme-icon-moon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" style="display:none">
          <path d="M13.5 10.5A6 6 0 015.5 2.5a6 6 0 108 8z"/>
        </svg>
        <span id="theme-label">Dark</span>
      </button>
    </div>
  </header>

  <!-- ═══════════════════════════════════════
       MAIN APP BODY
  ═══════════════════════════════════════ -->
  <main class="app-body">

    <!-- LEFT PANEL: Input -->
    <section class="panel panel-left" aria-label="JSONL Input">
      <div class="panel-header">
        <span class="panel-title">Input</span>
        <div class="panel-controls">
          <span class="panel-stat" id="input-stat">0 lines</span>
          <button class="btn" id="btn-clear" aria-label="Clear input" style="padding:4px 9px; font-size:11.5px;">
            Clear
          </button>
        </div>
      </div>
      <div class="textarea-wrap">
        <textarea
          id="jsonl-input"
          spellcheck="false"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          placeholder="Paste your JSONL here…

Each line is a JSON object:
{&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;}
{&quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;}
{&quot;event&quot;: &quot;click&quot;, &quot;ts&quot;: 1700000000}"
          aria-label="JSONL input text area"
        ></textarea>
      </div>
    </section>

    <!-- RIGHT PANEL: Output -->
    <section class="panel panel-right" aria-label="Parsed JSON lines">
      <div class="panel-header">
        <span class="panel-title">Parsed Lines</span>
        <div class="panel-controls">
          <span class="panel-stat" id="output-stat">–</span>
        </div>
      </div>
      <div id="output" role="list" aria-live="polite" aria-label="Parsed JSON results">
        <!-- Empty state shown by JS -->
      </div>
    </section>

  </main>

  <script>
    /**
     * JSONL Viewer – Pure Vanilla JS
     * ─────────────────────────────
     * Modules:
     *  1. Theme          – light/dark toggle with localStorage
     *  2. Parser         – line-by-line JSON parsing
     *  3. Highlighter    – HTML syntax coloring
     *  4. Renderer       – build DOM for each line
     *  5. App Controller – wires up events, debouncing, state
     */

    (() => {
      'use strict';

      // ──────────────────────────────────────────
      // 1. THEME MODULE
      // ──────────────────────────────────────────
      const Theme = (() => {
        const STORAGE_KEY = 'jsonl-viewer-theme';
        const html = document.documentElement;
        const btnTheme = document.getElementById('btn-theme');
        const themeLabel = document.getElementById('theme-label');
        const iconSun = document.getElementById('theme-icon-sun');
        const iconMoon = document.getElementById('theme-icon-moon');

        /** Apply a theme ('light' | 'dark') to the document */
        function apply(mode) {
          html.setAttribute('data-theme', mode);
          if (mode === 'dark') {
            iconSun.style.display = 'none';
            iconMoon.style.display = '';
            themeLabel.textContent = 'Light';
          } else {
            iconSun.style.display = '';
            iconMoon.style.display = 'none';
            themeLabel.textContent = 'Dark';
          }
        }

        /** Toggle between light and dark */
        function toggle() {
          const current = html.getAttribute('data-theme') || 'light';
          const next = current === 'light' ? 'dark' : 'light';
          apply(next);
          try { localStorage.setItem(STORAGE_KEY, next); } catch (_) {}
        }

        /** Initialise from localStorage or OS preference */
        function init() {
          let saved = null;
          try { saved = localStorage.getItem(STORAGE_KEY); } catch (_) {}
          if (saved === 'light' || saved === 'dark') {
            apply(saved);
          } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            apply('dark');
          } else {
            apply('light');
          }
        }

        btnTheme.addEventListener('click', toggle);
        return { init };
      })();

      // ──────────────────────────────────────────
      // 2. PARSER MODULE
      // ──────────────────────────────────────────
      const Parser = (() => {
        /**
         * Parse a JSONL string into an array of result objects.
         * Each result: { lineNumber, raw, valid, parsed?, error? }
         */
        function parseJsonl(text) {
          const lines = text.split('\n');
          const results = [];
          let lineNumber = 0;

          for (const raw of lines) {
            const trimmed = raw.trim();
            if (!trimmed) continue; // skip blank lines

            lineNumber++;
            try {
              const parsed = JSON.parse(trimmed);
              results.push({ lineNumber, raw: trimmed, valid: true, parsed });
            } catch (err) {
              results.push({ lineNumber, raw: trimmed, valid: false, error: err.message });
            }
          }

          return results;
        }

        return { parseJsonl };
      })();

      // ──────────────────────────────────────────
      // 3. HIGHLIGHTER MODULE
      // ──────────────────────────────────────────
      const Highlighter = (() => {
        /** Escape HTML special characters */
        function esc(str) {
          return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        }

        /**
         * Syntax-highlight a JSON string.
         * Uses a regex-based tokenizer – works on well-formed JSON.
         * Returns an HTML string with span classes.
         */
        function highlight(jsonStr) {
          // Token regex: matches strings, numbers, booleans, null, or punctuation
          const TOKEN = /("(?:[^"\\]|\\.)*"(?:\s*:)?)|(\b(?:true|false)\b)|(\bnull\b)|(-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)|([{}[\],:])/g;

          return jsonStr.replace(TOKEN, (match, strOrKey, bool, nil, num, punct) => {
            if (strOrKey !== undefined) {
              // Determine if this is a key (ends with colon after closing quote)
              if (strOrKey.trimEnd().endsWith(':')) {
                // Extract just the key part (without the colon)
                const colon = strOrKey.lastIndexOf(':');
                return `<span class="jk">${esc(strOrKey.slice(0, colon))}</span><span class="jp">:</span>`;
              }
              return `<span class="js">${esc(strOrKey)}</span>`;
            }
            if (bool  !== undefined) return `<span class="jb">${esc(bool)}</span>`;
            if (nil   !== undefined) return `<span class="jz">${esc(nil)}</span>`;
            if (num   !== undefined) return `<span class="jn">${esc(num)}</span>`;
            if (punct !== undefined) return `<span class="jp">${esc(punct)}</span>`;
            return esc(match);
          });
        }

        /**
         * Format a parsed JS value as pretty-printed JSON,
         * then syntax-highlight it.
         */
        function prettyHighlight(parsed) {
          const pretty = JSON.stringify(parsed, null, 2);
          return highlight(pretty);
        }

        /**
         * Produce a compact single-line highlighted JSON preview.
         * Truncated if very long, to avoid DOM bloat.
         */
        function inlineHighlight(parsed, maxLen = 400) {
          let compact = JSON.stringify(parsed);
          if (compact.length > maxLen) {
            compact = compact.slice(0, maxLen) + '…';
          }
          return highlight(compact);
        }

        return { prettyHighlight, inlineHighlight };
      })();

      // ──────────────────────────────────────────
      // 4. RENDERER MODULE
      // ──────────────────────────────────────────
      const Renderer = (() => {
        const outputEl = document.getElementById('output');
        const outputStat = document.getElementById('output-stat');

        // SVG icons as strings
        const ICON_COPY = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="5" y="1" width="9" height="11" rx="1.5"/>
          <path d="M3 4H2a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-1"/>
        </svg>`;

        const ICON_CHECK = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M2.5 8.5l4 4 7-7"/>
        </svg>`;

        const ICON_WARN = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 1.5L1 13.5h14L8 1.5z"/>
          <line x1="8" y1="6" x2="8" y2="9.5"/>
          <circle cx="8" cy="11.5" r="0.6" fill="currentColor" stroke="none"/>
        </svg>`;

        const EMPTY_ICON = `<svg class="empty-state-icon" viewBox="0 0 44 44" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="6" y="10" width="32" height="24" rx="4"/>
          <line x1="12" y1="18" x2="32" y2="18"/>
          <line x1="12" y1="22" x2="26" y2="22"/>
          <line x1="12" y1="26" x2="28" y2="26"/>
        </svg>`;

        /** Show an empty/placeholder state in the output panel */
        function renderEmpty(message) {
          outputEl.innerHTML = `
            <div class="empty-state" role="status">
              ${EMPTY_ICON}
              <p>${message}</p>
            </div>`;
          outputStat.textContent = '–';
        }

        /**
         * Build a DOM element for a single parsed line.
         * @param {object} result – from Parser.parseJsonl
         * @param {boolean} isExpanded – current expand state
         * @returns {HTMLElement}
         */
        function buildLineEl(result, isExpanded = false) {
          const card = document.createElement('div');
          card.className = 'json-line' + (result.valid ? '' : ' error') + (isExpanded ? ' expanded' : '');
          card.setAttribute('role', 'listitem');
          card.dataset.line = result.lineNumber;

          if (result.valid) {
            // ── Valid line ──
            const prettyHtml   = Highlighter.prettyHighlight(result.parsed);
            const inlineHtml   = Highlighter.inlineHighlight(result.parsed);
            const prettyText   = JSON.stringify(result.parsed, null, 2);

            card.innerHTML = `
              <div class="json-line-header">
                <button class="btn-toggle" aria-label="${isExpanded ? 'Collapse' : 'Expand'} line ${result.lineNumber}" aria-expanded="${isExpanded}">${isExpanded ? '−' : '+'}</button>
                <span class="line-num" aria-label="Line ${result.lineNumber}">${result.lineNumber}</span>
                <span class="json-inline" aria-hidden="true">${inlineHtml}</span>
                <button class="btn-copy" title="Copy formatted JSON" aria-label="Copy JSON for line ${result.lineNumber}">${ICON_COPY}</button>
              </div>
              <div class="json-body" aria-hidden="${!isExpanded}">
                <pre class="json-pre" tabindex="0" aria-label="Formatted JSON for line ${result.lineNumber}">${prettyHtml}</pre>
              </div>`;

            // Wire up toggle
            const toggleBtn = card.querySelector('.btn-toggle');
            const jsonBody  = card.querySelector('.json-body');
            toggleBtn.addEventListener('click', () => toggleLine(card, toggleBtn, jsonBody));

            // Wire up copy
            const copyBtn = card.querySelector('.btn-copy');
            copyBtn.addEventListener('click', () => copyText(prettyText, copyBtn));

          } else {
            // ── Invalid line ──
            card.innerHTML = `
              <div class="json-line-header">
                <span class="line-num" aria-label="Line ${result.lineNumber}">${result.lineNumber}</span>
                <span class="error-label">
                  ${ICON_WARN}
                  Invalid JSON
                </span>
                <span class="json-inline" style="color: var(--text-error); opacity: 0.75;" aria-hidden="true">${escHtml(result.raw.slice(0, 80))}${result.raw.length > 80 ? '…' : ''}</span>
              </div>
              <div class="error-body">
                <div class="error-raw" tabindex="0" aria-label="Raw content of invalid line ${result.lineNumber}">${escHtml(result.raw)}</div>
                <div class="error-msg">
                  ${ICON_WARN}
                  <span>${escHtml(result.error)}</span>
                </div>
              </div>`;
          }

          return card;
        }

        /** Simple HTML escape helper */
        function escHtml(str) {
          return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }

        /**
         * Toggle a single line's expand/collapse state.
         * Uses real scrollHeight so content is never clipped by an
         * arbitrary max-height cap, no matter how large the JSON is.
         */
        function toggleLine(card, toggleBtn, jsonBody) {
          const expanding = !card.classList.contains('expanded');

          if (expanding) {
            // 1. Add class so CSS padding/border-top kick in
            card.classList.add('expanded');
            // 2. Measure true content height
            jsonBody.style.height = 'auto';
            const fullH = jsonBody.scrollHeight;
            // 3. Snap back to 0 so the transition animates from 0
            jsonBody.style.height = '0px';
            // 4. Force reflow, then set target height
            jsonBody.getBoundingClientRect();
            jsonBody.style.height = fullH + 'px';
            // 5. After transition ends, switch to 'auto' so resizing
            //    the window never clips the content
            jsonBody.addEventListener('transitionend', function onEnd() {
              if (card.classList.contains('expanded')) {
                jsonBody.style.height = 'auto';
              }
              jsonBody.removeEventListener('transitionend', onEnd);
            }, { once: true });
          } else {
            // Collapsing: pin current height first, then animate to 0
            jsonBody.style.height = jsonBody.scrollHeight + 'px';
            jsonBody.getBoundingClientRect();
            jsonBody.style.height = '0px';
            card.classList.remove('expanded');
          }

          toggleBtn.textContent = expanding ? '−' : '+';
          toggleBtn.setAttribute('aria-expanded', expanding);
          toggleBtn.setAttribute('aria-label', `${expanding ? 'Collapse' : 'Expand'} line ${card.dataset.line}`);
          jsonBody.setAttribute('aria-hidden', !expanding);
        }

        /**
         * Apply correct height to a json-body already in expanded state
         * (restored after a re-render). Called after element is in the DOM.
         */
        function applyExpandedHeight(jsonBody) {
          jsonBody.style.height = 'auto';
        }

        /** Copy text to clipboard; briefly show a check icon */
        function copyText(text, btn) {
          if (!navigator.clipboard) {
            // Fallback for older browsers
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity  = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch (_) {}
            document.body.removeChild(ta);
            showCopied(btn);
            return;
          }
          navigator.clipboard.writeText(text).then(() => showCopied(btn)).catch(() => {});
        }

        /** Briefly flash the copy button as "copied" */
        function showCopied(btn) {
          btn.classList.add('copied');
          btn.innerHTML = ICON_CHECK;
          btn.setAttribute('aria-label', btn.getAttribute('aria-label').replace('Copy', 'Copied'));
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = ICON_COPY;
            btn.setAttribute('aria-label', btn.getAttribute('aria-label').replace('Copied', 'Copy'));
          }, 1500);
        }

        /**
         * Render all parsed results to the output panel.
         * @param {Array}  results        – from Parser
         * @param {object} expandedState  – map of lineNumber → boolean
         */
        function render(results, expandedState = {}) {
          if (!results.length) {
            renderEmpty('Paste JSONL on the left to see parsed output here.<br><br>Supports one <code>JSON</code> object per line.');
            return;
          }

          const fragment = document.createDocumentFragment();
          let validCount = 0;
          let errorCount = 0;

          for (const result of results) {
            const isExpanded = expandedState[result.lineNumber] || false;
            const el = buildLineEl(result, isExpanded);
            fragment.appendChild(el);
            if (result.valid) validCount++; else errorCount++;
          }

          outputEl.replaceChildren(fragment);

          // For any lines pre-rendered as expanded, set height=auto now that
          // they are in the DOM — this ensures full content is always visible.
          const expandedBodies = outputEl.querySelectorAll('.json-line.expanded .json-body');
          for (const body of expandedBodies) {
            body.style.height = 'auto';
          }

          // Update stat
          const parts = [`${validCount} valid`];
          if (errorCount) parts.push(`${errorCount} error${errorCount > 1 ? 's' : ''}`);
          outputStat.textContent = parts.join(', ');
        }

        /** Expand or collapse all currently rendered lines */
        function setAllExpanded(expand) {
          const cards   = outputEl.querySelectorAll('.json-line:not(.error)');
          for (const card of cards) {
            const toggleBtn = card.querySelector('.btn-toggle');
            const jsonBody  = card.querySelector('.json-body');
            if (!toggleBtn || !jsonBody) continue;

            const isExpanded = card.classList.contains('expanded');
            if (expand !== isExpanded) {
              toggleLine(card, toggleBtn, jsonBody);
            }
          }
        }

        /** Read current expand/collapse state from the DOM */
        function getExpandedState() {
          const state = {};
          const cards = outputEl.querySelectorAll('.json-line:not(.error)');
          for (const card of cards) {
            const lineNum = parseInt(card.dataset.line, 10);
            state[lineNum] = card.classList.contains('expanded');
          }
          return state;
        }

        return { render, renderEmpty, setAllExpanded, getExpandedState };
      })();

      // ──────────────────────────────────────────
      // 5. APP CONTROLLER
      // ──────────────────────────────────────────
      const App = (() => {
        const inputEl    = document.getElementById('jsonl-input');
        const inputStat  = document.getElementById('input-stat');
        const btnExpandAll  = document.getElementById('btn-expand-all');
        const btnCollapseAll = document.getElementById('btn-collapse-all');
        const btnClear   = document.getElementById('btn-clear');

        let debounceTimer = null;
        const DEBOUNCE_MS = 180;

        /** Count non-empty lines in the textarea */
        function countInputLines(text) {
          return text.split('\n').filter(l => l.trim().length > 0).length;
        }

        /** Update the "N lines" stat in the input panel header */
        function updateInputStat(text) {
          const n = countInputLines(text);
          inputStat.textContent = n === 1 ? '1 line' : `${n} lines`;
        }

        /** Main parse-and-render pipeline */
        function process() {
          const text = inputEl.value;
          updateInputStat(text);

          // Capture existing expand state before re-render
          const expandedState = Renderer.getExpandedState();

          if (!text.trim()) {
            Renderer.render([], {});
            return;
          }

          const results = Parser.parseJsonl(text);
          Renderer.render(results, expandedState);
        }

        /** Debounced version of process() */
        function scheduleProcess() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(process, DEBOUNCE_MS);
        }

        // ── Event Listeners ──

        inputEl.addEventListener('input', scheduleProcess);

        btnExpandAll.addEventListener('click', () => Renderer.setAllExpanded(true));
        btnCollapseAll.addEventListener('click', () => Renderer.setAllExpanded(false));

        btnClear.addEventListener('click', () => {
          inputEl.value = '';
          process();
          inputEl.focus();
        });

        // ── Initialise ──
        function init() {
          Theme.init();

          // Load any previously saved input (nice for dev re-use)
          // Skipped intentionally – keeping it simple & privacy-safe

          // Show placeholder empty state immediately
          process();
        }

        return { init };
      })();

      // ── Boot ──
      App.init();

    })();
  </script>
</body>
</html>
